<!DOCTYPE html>
<html>
<head>
  <title>Lakshmi Motor Cycle Spares</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body style="font-family: Arial; padding: 20px; background:#f4f4f4;">

<!-- ================= SHOP BRANDING ================= -->
<div style="text-align:center;padding:15px;margin-bottom:15px;background:#fff;border-radius:8px;">
  <h1 style="margin:0;font-size:22px;">üèçÔ∏è LAKSHMI MOTOR CYCLE SPARES</h1>
  <p style="margin:5px 0;color:#555;">Genuine 2-Wheeler Spare Parts</p>
  <p style="margin:5px 0;color:#777;">üöö Fast Delivery ‚Ä¢ üíØ Trusted Store</p>
</div>

<h3>üõµ Select Your Bike</h3>

<label>Brand</label>
<select id="brandSelect" style="width:100%;padding:10px;"></select><br><br>

<label>Model</label>
<select id="modelSelect" style="width:100%;padding:10px;"></select><br><br>

<label>Year</label>
<select id="yearSelect" style="width:100%;padding:10px;"></select><br><br>

<h3>Category</h3>
<div id="categories"></div>

<h3>Available Parts</h3>
<div id="parts"></div>

<script>
/* ================= CONFIG ================= */
const telegramUserId = Telegram.WebApp.initDataUnsafe?.user?.id || 0;
const SUPABASE_URL = "https://gmajjousigloyiablmeo.supabase.co";
const SUPABASE_KEY = "sb_publishable_anzjPC7WhQVAzPP1JSAm4g_W-G90zZY";

/* ================= ELEMENTS ================= */
const brandSelect = document.getElementById("brandSelect");
const modelSelect = document.getElementById("modelSelect");
const yearSelect  = document.getElementById("yearSelect");
const categoryDiv = document.getElementById("categories");
const partsDiv    = document.getElementById("parts");

/* ================= LOAD BRANDS ================= */
async function loadBrands() {
  brandSelect.innerHTML = `<option value="">Select Brand</option>`;
  modelSelect.innerHTML = `<option value="">Select Model</option>`;
  yearSelect.innerHTML  = `<option value="">Select Year</option>`;
  categoryDiv.innerHTML = "";
  partsDiv.innerHTML = "";

  const res = await fetch(`${SUPABASE_URL}/rest/v1/bike_brands?select=id,brand_name`,
    { headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}});
  const data = await res.json();
  data.forEach(b => brandSelect.innerHTML += `<option value="${b.id}">${b.brand_name}</option>`);
}

/* ================= LOAD MODELS ================= */
async function loadModels(id) {
  modelSelect.innerHTML = `<option value="">Select Model</option>`;
  yearSelect.innerHTML = `<option value="">Select Year</option>`;
  categoryDiv.innerHTML = "";
  partsDiv.innerHTML = "";

  const res = await fetch(`${SUPABASE_URL}/rest/v1/bike_models?brand_id=eq.${id}&select=id,model_name`,
    { headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}});
  const data = await res.json();
  data.forEach(m => modelSelect.innerHTML += `<option value="${m.id}">${m.model_name}</option>`);
}

/* ================= LOAD YEARS ================= */
async function loadYears(id) {
  yearSelect.innerHTML = `<option value="">Select Year</option>`;
  categoryDiv.innerHTML = "";
  partsDiv.innerHTML = "";

  const res = await fetch(`${SUPABASE_URL}/rest/v1/bike_years?model_id=eq.${id}&select=id,year`,
    { headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}});
  const data = await res.json();
  data.forEach(y => yearSelect.innerHTML += `<option value="${y.id}">${y.year}</option>`);
}

/* ================= LOAD CATEGORIES ================= */
async function loadCategories() {
  categoryDiv.innerHTML = "";
  partsDiv.innerHTML = "";

  const res = await fetch(`${SUPABASE_URL}/rest/v1/categories?select=id,category_name`,
    { headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}});
  const data = await res.json();

  data.forEach(c => {
    const btn = document.createElement("button");
    btn.textContent = c.category_name;
    btn.style.cssText = "width:100%;padding:12px;margin-bottom:8px;";
    btn.onclick = () => loadParts(c.id);
    categoryDiv.appendChild(btn);
  });
}

/* ================= LOAD PARTS ================= */
async function loadParts(categoryId) {
  partsDiv.innerHTML = "Loading parts...";

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/spare_parts?brand_id=eq.${brandSelect.value}&model_id=eq.${modelSelect.value}&year_id=eq.${yearSelect.value}&category_id=eq.${categoryId}&select=id,part_name,price,stock_qty`,
    { headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}});
  const parts = await res.json();

  partsDiv.innerHTML = "";
  if (!parts.length) return partsDiv.innerHTML = "No parts available";

  parts.forEach(p => {
    partsDiv.innerHTML += `
      <div style="background:#fff;padding:10px;margin-bottom:8px;">
        <b>${p.part_name}</b><br>
        ‚Çπ${p.price} | Stock: ${p.stock_qty}<br>
        <button onclick="addToCart('${p.id}', ${p.price})">Add to Cart</button>
      </div>`;
  });

  partsDiv.innerHTML += `<button onclick="loadCart()" style="width:100%;padding:12px;">üõí View Cart</button>`;
}

/* ================= ADD TO CART ================= */
async function addToCart(partId, price) {
  const check = await fetch(
    `${SUPABASE_URL}/rest/v1/cart_items?telegram_user_id=eq.${telegramUserId}&spare_part_id=eq.${partId}&select=id,quantity`,
    { headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}});
  const data = await check.json();

  if (data.length) {
    await fetch(`${SUPABASE_URL}/rest/v1/cart_items?id=eq.${data[0].id}`,{
      method:"PATCH",
      headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`,"Content-Type":"application/json"},
      body:JSON.stringify({quantity:data[0].quantity+1})
    });
  } else {
    await fetch(`${SUPABASE_URL}/rest/v1/cart_items`,{
      method:"POST",
      headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`,"Content-Type":"application/json"},
      body:JSON.stringify({telegram_user_id:telegramUserId,spare_part_id:partId,quantity:1,price})
    });
  }
  alert("Added to cart");
}

/* ================= LOAD CART ================= */
async function loadCart() {
  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/cart_items?telegram_user_id=eq.${telegramUserId}&select=id,price,quantity`,
    { headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}});
  const items = await res.json();

  if (!items.length) return partsDiv.innerHTML = "Cart is empty";

  let subtotal = 0;
  partsDiv.innerHTML = "<h3>Your Cart</h3>";
  items.forEach(i=>{
    subtotal += i.price * i.quantity;
    partsDiv.innerHTML += `<div>Qty ${i.quantity} √ó ‚Çπ${i.price}</div>`;
  });

  partsDiv.innerHTML += `
    <hr>
    Subtotal: ‚Çπ${subtotal}<br>
    Delivery: ‚Çπ200<br>
    <b>Total: ‚Çπ${subtotal+200}</b><br><br>
    <button onclick="showCheckout()" style="width:100%;padding:14px;">Proceed to Checkout</button>`;
}

/* ================= CHECKOUT ================= */
function showCheckout() {
  partsDiv.innerHTML = `
    <h3>üì¶ Delivery Address</h3>
    <input id="name" placeholder="Full Name*" style="width:100%;padding:8px"><br><br>
    <input id="phone" placeholder="Phone*" style="width:100%;padding:8px"><br><br>
    <input id="flat" placeholder="Flat / House No*" style="width:100%;padding:8px"><br><br>
    <input id="building" placeholder="Building / Apartment" style="width:100%;padding:8px"><br><br>
    <input id="area" placeholder="Area / Street*" style="width:100%;padding:8px"><br><br>
    <input id="landmark" placeholder="Landmark" style="width:100%;padding:8px"><br><br>
    <input id="city" placeholder="City*" style="width:100%;padding:8px"><br><br>
    <input id="state" placeholder="State*" style="width:100%;padding:8px"><br><br>
    <input id="pincode" placeholder="Pincode*" style="width:100%;padding:8px"><br><br>
    <input id="map" placeholder="Google Maps link (optional)" style="width:100%;padding:8px"><br><br>
    <button onclick="placeOrder()" style="width:100%;padding:14px;">üßæ Place Order</button>`;
}

/* ================= PLACE ORDER ================= */
async function placeOrder() {
  const name=document.getElementById("name").value.trim();
  const phone=document.getElementById("phone").value.trim();
  const flat=document.getElementById("flat").value.trim();
  const area=document.getElementById("area").value.trim();
  const city=document.getElementById("city").value.trim();
  const state=document.getElementById("state").value.trim();
  const pincode=document.getElementById("pincode").value.trim();
  const map=document.getElementById("map").value.trim();

  if(!name||!phone||!flat||!area||!city||!state||!pincode) return alert("Fill all required fields");

  const address = `${flat}, ${area}, ${city}, ${state} - ${pincode}${map? " | Map: "+map:""}`;
  alert("Order placed!\nAddress:\n"+address);
}

/* ================= EVENTS ================= */
brandSelect.onchange=()=>loadModels(brandSelect.value);
modelSelect.onchange=()=>loadYears(modelSelect.value);
yearSelect.onchange=()=>loadCategories();
loadBrands();
</script>

</body>
</html>
