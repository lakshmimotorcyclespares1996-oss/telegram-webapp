<!DOCTYPE html>
<html>
<head>
  <title>PK 2 Wheeler Spares</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body style="font-family: Arial; padding: 20px;">

<h2>üõµ Select Your Bike</h2>

<label>Bike Brand</label><br>
<select id="brandSelect" style="width:100%; padding:10px;"></select>
<br><br>

<label>Bike Model</label><br>
<select id="modelSelect" style="width:100%; padding:10px;"></select>
<br><br>

<label>Bike Year</label><br>
<select id="yearSelect" style="width:100%; padding:10px;"></select>

<br><br>
<h3>Select Category</h3>
<div id="categories"></div>

<br>
<h3>Available Parts</h3>
<div id="parts"></div>

<script>
/* ===============================
   CONFIG
================================ */
const telegramUserId = Telegram.WebApp.initDataUnsafe?.user?.id || 0;
const SUPABASE_URL = "https://gmajjousigloyiablmeo.supabase.co";
const SUPABASE_KEY = "sb_publishable_anzjPC7WhQVAzPP1JSAm4g_W-G90zZY";

/* ===============================
   ELEMENTS
================================ */
const brandSelect = document.getElementById("brandSelect");
const modelSelect = document.getElementById("modelSelect");
const yearSelect  = document.getElementById("yearSelect");
const categoryDiv = document.getElementById("categories");
const partsDiv    = document.getElementById("parts");

/* ===============================
   LOAD BRANDS
================================ */
async function loadBrands() {
  brandSelect.innerHTML = `<option value="">Select Brand</option>`;
  modelSelect.innerHTML = `<option value="">Select Model</option>`;
  yearSelect.innerHTML  = `<option value="">Select Year</option>`;
  categoryDiv.innerHTML = "";
  partsDiv.innerHTML = "";

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/bike_brands?select=id,brand_name`,
    { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
  );

  const brands = await res.json();
  brands.forEach(b => {
    brandSelect.innerHTML += `<option value="${b.id}">${b.brand_name}</option>`;
  });
}

/* ===============================
   LOAD MODELS
================================ */
async function loadModels(brandId) {
  modelSelect.innerHTML = `<option value="">Select Model</option>`;
  yearSelect.innerHTML  = `<option value="">Select Year</option>`;
  categoryDiv.innerHTML = "";
  partsDiv.innerHTML = "";

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/bike_models?brand_id=eq.${brandId}&select=id,model_name`,
    { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
  );

  const models = await res.json();
  models.forEach(m => {
    modelSelect.innerHTML += `<option value="${m.id}">${m.model_name}</option>`;
  });
}

/* ===============================
   LOAD YEARS
================================ */
async function loadYears(modelId) {
  yearSelect.innerHTML = `<option value="">Select Year</option>`;
  categoryDiv.innerHTML = "";
  partsDiv.innerHTML = "";

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/bike_years?model_id=eq.${modelId}&select=id,year`,
    { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
  );

  const years = await res.json();
  years.forEach(y => {
    yearSelect.innerHTML += `<option value="${y.id}">${y.year}</option>`;
  });
}

/* ===============================
   LOAD CATEGORIES
================================ */
async function loadCategories() {
  categoryDiv.innerHTML = "";
  partsDiv.innerHTML = "";

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/categories?select=id,category_name`,
    { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
  );

  const categories = await res.json();
  categories.forEach(c => {
    const btn = document.createElement("button");
    btn.innerText = c.category_name;
    btn.style.display = "block";
    btn.style.width = "100%";
    btn.style.padding = "12px";
    btn.style.marginBottom = "8px";
    btn.onclick = () => loadParts(c.id);
    categoryDiv.appendChild(btn);
  });
}

/* ===============================
   LOAD PARTS
================================ */
async function loadParts(categoryId) {
  partsDiv.innerHTML = "Loading parts...";

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/spare_parts?brand_id=eq.${brandSelect.value}&model_id=eq.${modelSelect.value}&year_id=eq.${yearSelect.value}&category_id=eq.${categoryId}&select=id,part_name,price,stock_qty`,
    {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    }
  );

  const parts = await res.json();
  partsDiv.innerHTML = "";

  if (parts.length === 0) {
    partsDiv.innerHTML = "No parts available";
    return;
  }

  // 1Ô∏è‚É£ Show all parts FIRST
  parts.forEach(p => {
    partsDiv.innerHTML += `
      <div style="border:1px solid #ddd;padding:10px;margin-bottom:8px;">
        <b>${p.part_name}</b><br>
        Price: ‚Çπ${p.price}<br>
        Available Qty: ${p.stock_qty}<br>
        <button onclick="addToCart('${p.id}', '${p.part_name}', ${p.price})">
          Add to Cart
        </button>
      </div>
    `;
  });

  // 2Ô∏è‚É£ Show View Cart button AT THE END
  partsDiv.innerHTML += `
    <button onclick="loadCart()" style="padding:12px;width:100%;margin-top:10px;">
      üõí View Cart
    </button>
  `;
}
/* ===============================
   ADD TO CART FUNCTION
================================ */
async function addToCart(partId, partName, price) {
  if (!telegramUserId) {
    alert("Telegram user not detected");
    return;
  }

  // 1Ô∏è‚É£ Check if item already exists in cart
  const checkRes = await fetch(
    `${SUPABASE_URL}/rest/v1/cart_items?telegram_user_id=eq.${telegramUserId}&spare_part_id=eq.${partId}&select=id,quantity`,
    {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    }
  );

  const existing = await checkRes.json();

  // 2Ô∏è‚É£ If exists ‚Üí update quantity
  if (existing.length > 0) {
    const item = existing[0];

    await fetch(
      `${SUPABASE_URL}/rest/v1/cart_items?id=eq.${item.id}`,
      {
        method: "PATCH",
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          quantity: item.quantity + 1
        })
      }
    );
  } 
  // 3Ô∏è‚É£ Else ‚Üí insert new row
  else {
    await fetch(
      `${SUPABASE_URL}/rest/v1/cart_items`,
      {
        method: "POST",
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          telegram_user_id: telegramUserId,
          spare_part_id: partId,
          quantity: 1,
          price: price
        })
      }
    );
  }

  alert(partName + " added to cart");
}

/* ===============================
   LOAD CART FUNCTION
================================ */
  async function loadCart() {
  partsDiv.innerHTML = "Loading cart...";

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/cart_items?telegram_user_id=eq.${telegramUserId}&select=id,price,quantity`,
    {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    }
  );

  const items = await res.json();

  if (items.length === 0) {
    partsDiv.innerHTML = "Cart is empty";
    return;
  }

  let subtotal = 0;
  partsDiv.innerHTML = "<h3>Your Cart</h3>";

  items.forEach(i => {
    const itemTotal = i.price * i.quantity;
    subtotal += itemTotal;

    partsDiv.innerHTML += `
      <div style="border:1px solid #ccc;padding:8px;margin-bottom:6px">
        Qty: ${i.quantity} √ó ‚Çπ${i.price} = ‚Çπ${itemTotal}
        <button onclick="removeCartItem('${i.id}')">‚ùå</button>
      </div>
    `;
  });

  partsDiv.innerHTML += `
    <hr>
    Subtotal: ‚Çπ${subtotal}<br>
    Delivery: ‚Çπ200<br>
    <b>Total: ‚Çπ${subtotal + 200}</b>
  `;
}
/* ===============================
   REMOVE ITEM FUNCTION
================================ */
  async function removeCartItem(id) {
  await fetch(
    `${SUPABASE_URL}/rest/v1/cart_items?id=eq.${id}`,
    {
      method: "DELETE",
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    }
  );

  loadCart();
}

/* ===============================
   EVENTS
================================ */
brandSelect.onchange = () => brandSelect.value && loadModels(brandSelect.value);
modelSelect.onchange = () => modelSelect.value && loadYears(modelSelect.value);
yearSelect.onchange  = () => yearSelect.value && loadCategories();

/* ===============================
   START
================================ */
loadBrands();
</script>

</body>
</html>
