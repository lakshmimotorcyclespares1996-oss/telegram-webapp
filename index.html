<!DOCTYPE html>
<html>
<head>
  <title>Lakshmi Motor Cycle Spares</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body style="font-family: Arial; padding: 20px; background:#f9f9f9;">

<!-- ===============================
     SHOP BRANDING
================================ -->
<div style="text-align:center;padding:15px;margin-bottom:15px;background:#fff;border:1px solid #ddd;border-radius:8px;">
  <h1 style="margin:0;font-size:22px;color:#000;">üèçÔ∏è LAKSHMI MOTOR CYCLE SPARES</h1>
  <p style="margin:5px 0;font-size:14px;color:#333;">Genuine 2-Wheeler Spare Parts</p>
  <p style="margin:5px 0;font-size:13px;color:#555;">üöö Fast Delivery ‚Ä¢ üíØ Trusted Store</p>
</div>

<h2>üõµ Select Your Bike</h2>

<label>Bike Brand</label><br>
<select id="brandSelect" style="width:100%;padding:10px;"></select><br><br>

<label>Bike Model</label><br>
<select id="modelSelect" style="width:100%;padding:10px;"></select><br><br>

<label>Bike Year</label><br>
<select id="yearSelect" style="width:100%;padding:10px;"></select><br><br>

<h3>Select Category</h3>
<div id="categories"></div>

<h3>Available Parts</h3>
<div id="parts"></div>

<script>
/* ===============================
   CONFIG
================================ */
const telegramUserId = Telegram.WebApp.initDataUnsafe?.user?.id || 0;
const SUPABASE_URL = "https://gmajjousigloyiablmeo.supabase.co";
const SUPABASE_KEY = "sb_publishable_anzjPC7WhQVAzPP1JSAm4g_W-G90zZY";

/* ===============================
   ELEMENTS
================================ */
const brandSelect = document.getElementById("brandSelect");
const modelSelect = document.getElementById("modelSelect");
const yearSelect  = document.getElementById("yearSelect");
const categoryDiv = document.getElementById("categories");
const partsDiv    = document.getElementById("parts");

/* ===============================
   LOAD BRANDS
================================ */
async function loadBrands() {
  brandSelect.innerHTML = `<option value="">Select Brand</option>`;
  modelSelect.innerHTML = `<option value="">Select Model</option>`;
  yearSelect.innerHTML  = `<option value="">Select Year</option>`;
  categoryDiv.innerHTML = "";
  partsDiv.innerHTML = "";

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/bike_brands?select=id,brand_name`,
    { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
  );
  const data = await res.json();
  data.forEach(b => brandSelect.innerHTML += `<option value="${b.id}">${b.brand_name}</option>`);
}

/* ===============================
   LOAD MODELS
================================ */
async function loadModels(brandId) {
  modelSelect.innerHTML = `<option value="">Select Model</option>`;
  yearSelect.innerHTML  = `<option value="">Select Year</option>`;
  categoryDiv.innerHTML = "";
  partsDiv.innerHTML = "";

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/bike_models?brand_id=eq.${brandId}&select=id,model_name`,
    { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
  );
  const data = await res.json();
  data.forEach(m => modelSelect.innerHTML += `<option value="${m.id}">${m.model_name}</option>`);
}

/* ===============================
   LOAD YEARS
================================ */
async function loadYears(modelId) {
  yearSelect.innerHTML = `<option value="">Select Year</option>`;
  categoryDiv.innerHTML = "";
  partsDiv.innerHTML = "";

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/bike_years?model_id=eq.${modelId}&select=id,year`,
    { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
  );
  const data = await res.json();
  data.forEach(y => yearSelect.innerHTML += `<option value="${y.id}">${y.year}</option>`);
}

/* ===============================
   LOAD CATEGORIES
================================ */
async function loadCategories() {
  categoryDiv.innerHTML = "";
  partsDiv.innerHTML = "";

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/categories?select=id,category_name`,
    { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
  );
  const data = await res.json();

  data.forEach(c => {
    const btn = document.createElement("button");
    btn.textContent = c.category_name;
    btn.style.cssText = "width:100%;padding:12px;margin-bottom:8px;";
    btn.onclick = () => loadParts(c.id);
    categoryDiv.appendChild(btn);
  });
}

/* ===============================
   LOAD PARTS
================================ */
async function loadParts(categoryId) {
  partsDiv.innerHTML = "Loading parts...";

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/spare_parts?brand_id=eq.${brandSelect.value}&model_id=eq.${modelSelect.value}&year_id=eq.${yearSelect.value}&category_id=eq.${categoryId}&select=id,part_name,price,stock_qty`,
    { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
  );
  const parts = await res.json();
  partsDiv.innerHTML = "";

  if (!parts.length) {
    partsDiv.innerHTML = "No parts available";
    return;
  }

  parts.forEach(p => {
    partsDiv.innerHTML += `
      <div style="background:#fff;border:1px solid #ddd;padding:10px;margin-bottom:8px;">
        <b>${p.part_name}</b><br>
        Price: ‚Çπ${p.price}<br>
        Available Qty: ${p.stock_qty}<br>
        <button onclick="addToCart('${p.id}', ${p.price})">Add to Cart</button>
      </div>
    `;
  });

  partsDiv.innerHTML += `
    <button onclick="loadCart()" style="padding:12px;width:100%;margin-top:10px;">
      üõí View Cart
    </button>
  `;
}

/* ===============================
   ADD TO CART
================================ */
async function addToCart(partId, price) {
  const check = await fetch(
    `${SUPABASE_URL}/rest/v1/cart_items?telegram_user_id=eq.${telegramUserId}&spare_part_id=eq.${partId}&select=id,quantity`,
    { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
  );
  const existing = await check.json();

  if (existing.length) {
    await fetch(`${SUPABASE_URL}/rest/v1/cart_items?id=eq.${existing[0].id}`, {
      method:"PATCH",
      headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`,"Content-Type":"application/json"},
      body:JSON.stringify({quantity: existing[0].quantity + 1})
    });
  } else {
    await fetch(`${SUPABASE_URL}/rest/v1/cart_items`, {
      method:"POST",
      headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`,"Content-Type":"application/json"},
      body:JSON.stringify({telegram_user_id:telegramUserId,spare_part_id:partId,quantity:1,price})
    });
  }
  alert("Added to cart");
}

/* ===============================
   LOAD CART
================================ */
async function loadCart() {
  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/cart_items?telegram_user_id=eq.${telegramUserId}&select=id,price,quantity`,
    { headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`} }
  );
  const items = await res.json();
  if (!items.length) { partsDiv.innerHTML="Cart is empty"; return; }

  let subtotal = 0;
  partsDiv.innerHTML="<h3>Your Cart</h3>";

  items.forEach(i=>{
    subtotal+=i.price*i.quantity;
    partsDiv.innerHTML+=`
      <div style="border:1px solid #ccc;padding:8px;margin-bottom:6px;">
        Qty ${i.quantity} √ó ‚Çπ${i.price}
      </div>`;
  });

  partsDiv.innerHTML+=`
    <hr>
    Subtotal: ‚Çπ${subtotal}<br>
    Delivery: ‚Çπ200<br>
    <b>Total: ‚Çπ${subtotal+200}</b><br><br>
    <button onclick="showCheckout()" style="padding:14px;width:100%;">Proceed to Checkout</button>
  `;
}

/* ===============================
   CHECKOUT UI
================================ */
function showCheckout(){
  partsDiv.innerHTML=`
    <h3>Checkout</h3>
    <input id="custName" placeholder="Name" style="width:100%;padding:8px"><br><br>
    <input id="custPhone" placeholder="Phone" style="width:100%;padding:8px"><br><br>
    <textarea id="custAddress" placeholder="Address" style="width:100%;padding:8px"></textarea><br><br>
    <button onclick="placeOrder()" style="padding:14px;width:100%;">Place Order</button>
  `;
}

/* ===============================
   EVENTS + START
================================ */
brandSelect.onchange=()=>brandSelect.value&&loadModels(brandSelect.value);
modelSelect.onchange=()=>modelSelect.value&&loadYears(modelSelect.value);
yearSelect.onchange =()=>yearSelect.value && loadCategories();
loadBrands();
</script>

</body>
</html>
